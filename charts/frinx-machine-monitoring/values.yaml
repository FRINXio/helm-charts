# Default values for frinx-machine-monitoring.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

kube-prometheus-stack:
  enabled: true
  crds:
    enabled: false

  # Grafana settings  
  grafana:
    enabled: true
    fullnameOverride: "grafana"
    adminUser: frinx
    adminPassword: frinx123!
    # Current port - will be removed
    service:
      port: 3001

    sidecar:
      dashboards:
        folder: /tmp/dashboards/Frinx-Machine
        folderAnnotation: grafana_folder
        provider:
          allowUiUpdates: true
          foldersFromFilesStructure: true

    additionalDataSources:
      - name: InfluxDB
        type: influxdb
        access: proxy
        basicAuth: true
        basicAuthUser: frinx
        basicAuthPassword: frinx123!
        url: http://influxdb
        jsonData:
          httpMode: POST
          authType: basic
          tlsSkipVerify: true
          organization: frinx-machine
          defaultBucket: frinx
          version: flux
        secureJsonData:
          token: eyJrIjoiN09MSVpVZjlVRG1xNHlLNXpVbmZJOXFLWU1GOXFxNEIiLCJuIjoic3Nzc3MiLCJpZCI6MX0  
       
      - name: Loki
        access: proxy
        type: loki
        url: http://loki:3100

  prometheus:
    prometheusSpec: 
      serviceMonitorSelector:
        matchExpressions:
          - key: app.kubernetes.io/instance
            operator: In
            values:
              - frinx-machine
              - frinx-machine-monitoring
              - uniconfig
              - workflow-manager  

      podMonitorSelector:
        matchExpressions:
          - key: cnpg.io/cluster
            operator: In
            values:
              - uniconfig-postgresql
              - postgresql

loki:
  enabled: true
  fullnameOverride: loki
  loki:
    config: |
      chunk_store_config:
        max_look_back_period: 24h
      table_manager:
        retention_deletes_enabled: false
        retention_period: 24h

promtail:
  fullnameOverride: promtail
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
    snippets:
      pipelineStages:
        - cri: {}
      scrapeConfigs: |
        - job_name: kubernetes-pods
          pipeline_stages:
            {{- toYaml .Values.config.snippets.pipelineStages | nindent 4 }}
          kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                  - {{ .Release.Namespace }}
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_controller_name
              regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
              action: replace
              target_label: __tmp_controller_name
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_name
                - __meta_kubernetes_pod_label_app
                - __tmp_controller_name
                - __meta_kubernetes_pod_name
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                - __meta_kubernetes_pod_label_release
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: instance
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_component
                - __meta_kubernetes_pod_label_component
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: component
            {{- if .Values.config.snippets.addScrapeJobLabel }}
            - replacement: kubernetes-pods
              target_label: scrape_job
            {{- end }}
            {{- toYaml .Values.config.snippets.common | nindent 4 }}
            {{- with .Values.config.snippets.extraRelabelConfigs }}
            {{- toYaml . | nindent 4 }}
            {{- end }}   